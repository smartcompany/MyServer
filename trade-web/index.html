<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    h2, h3 {
      text-align: center;
    }

    label {
      display: block;
      margin-bottom: 10px;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      margin-bottom: 15px;
      box-sizing: border-box;
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }

    pre {
      background: #f4f4f4;
      padding: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    #loginForm {
      display: flex;
      flex-direction: column;
    }

    #loginArea {
      margin-top: 40px;
    }

    .initButton {
      float: left;
    }
  </style>
  <meta charset="UTF-8">
  <title>íŠ¸ë ˆì´ë”© ì„¤ì •</title>
</head>
<body>
  <div id="loginArea">
  <h2>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <form id="loginForm">
      <label>ID: <input id="id" type="text" placeholder="admin" autocomplete="username"/></label><br>
      <label>PW: <input id="pw" type="password" placeholder="password" autocomplete="current-password"/></label><br>
      <button type="submit">ë¡œê·¸ì¸</button>
    </form>
  </div>

  <div id="mainArea" style="display: none;">
    <h3>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ê¸°ì¤€ ì„¤ì •</h3>
    ë§¤ìˆ˜ ê¸°ì¤€: <input id="buy" type="number" step="0.01"><br>
    ë§¤ë„ ê¸°ì¤€: <input id="sell" type="number" step="0.01"><br>
    <label>
      <input type="radio" name="trade-type" value="money" checked onclick="toggleInput('money')"> ê¸ˆì•¡ìœ¼ë¡œ ë§¤ë§¤
    </label>
    <label> 
      <input type="radio" name="trade-type" value="volume" onclick="toggleInput('volume')"> ìˆ˜ëŸ‰ìœ¼ë¡œ ë§¤ë§¤
    </label>
    <input id="tradeAmount" type="number" step="1"><br>
    <h3>íŠ¸ë ˆì´ë”© ì„¤ì •</h3>
  <label>
    <input id="isTrading" type="checkbox" onclick="updateConfig()">
    íŠ¸ë ˆì´ë”© ì‹œì‘/ì¤‘ì§€
    <button class="initbutton" onclick="confirmReset()" style="background-color: #f44336;">ë§¤ë§¤ ì´ˆê¸°í™”</button>
  </label>

    <button onclick="updateConfig()">ì„¤ì • ì ìš©</button>
    
    <div>
      <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;">
        <button onclick="showTab('log')" id="tabLog" style="flex:1; padding: 10px; background-color: #ddd;">ìµœê·¼ ë¡œê·¸</button>
        <button onclick="showTab('trade')" id="tabTrade" style="flex:1; padding: 10px; background-color: #4CAF50; color: white;">ê±°ë˜ ë‚´ì—­</button>
      </div>
      <div id="tradeTab"><pre id="tradeArea">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</pre></div>
      <div id="logTab" style="display: none;"><pre id="logArea">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</pre></div>
    </div>
    
  </div>

  <script>
    document.getElementById('loginForm').addEventListener('submit', function(event) {
      event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
      login();
    });

    async function login() {
      const id = document.getElementById('id').value;
      const pw = document.getElementById('pw').value;

      const res = await fetch('/trade-api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password: pw })
      });

      if (res.ok) {
        const data = await res.json();
        token = data.token;
        console.log('ë¡œê·¸ì¸ ì„±ê³µ, í† í°: ì €ì¥ ', token);
        localStorage.setItem('token', token);

        showMain();
      } else {
        alert('ë¡œê·¸ì¸ ì‹¤íŒ¨!');
      }
    }

    function showMain() {
      document.getElementById('loginArea').style.display = 'none';
      document.getElementById('mainArea').style.display = 'block';

      loadConfig();
      loadTradeLogs();
      loadLogs();
      setInterval(loadLogs, 5000);
      setInterval(loadTradeLogs, 5000);
      showTab('log');
    }

    function showLogin() {
      document.getElementById('loginArea').style.display = 'block';
      document.getElementById('mainArea').style.display = 'none';
      localStorage.removeItem('token');
    }

    async function loadConfig() {
      const token = localStorage.getItem('token');
      console.log('call get config API with token:', token);
      const res = await fetch('/trade-api/config', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      console.log('set config form with data:', data);
      document.getElementById('buy').value = data.buyThreshold;
      document.getElementById('sell').value = data.sellThreshold;
      document.getElementById('isTrading').checked = data.isTrading;
      document.getElementById('tradeAmount').value = data.tradeAmount;

      if (data.isTradeByMoney) {
        document.querySelector('input[name="trade-type"][value="money"]').checked = true;
      } else {
        document.querySelector('input[name="trade-type"][value="volume"]').checked = true;
      }
    }

    async function updateConfig() {
      const token = localStorage.getItem('token');
      const buy = parseFloat(document.getElementById('buy').value);
      const sell = parseFloat(document.getElementById('sell').value);
      const isTrading = document.getElementById('isTrading').checked;

      const tradeAmount = parseFloat(document.getElementById('tradeAmount').value);
      const tradeType = document.querySelector('input[name="trade-type"]:checked').value;
      const isTradeByMoney = (tradeType === 'money') ? true : false;

      console.log('ì„¤ì • ì—…ë°ì´íŠ¸ :', { buy, sell });
      console.log('call update config API with token:', token);
      const res = await fetch('/trade-api/config', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          updates: [
            { key: 'buyThreshold', value: buy },
            { key: 'sellThreshold', value: sell },
            { key: 'isTrading', value: isTrading },
            { key: 'tradeAmount', value: tradeAmount },
            { key: 'isTradeByMoney', value: isTradeByMoney }
          ]
        })
      });

      if (res.ok) {
        alert('ì„¤ì •ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤');
      } else {
        alert('ì„¤ì • ì‹¤íŒ¨!');
      }
    }

    async function confirmReset() {
      if (confirm("ë§¤ë§¤ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        const token = localStorage.getItem('token');
        const res = await fetch('/trade-api/init', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        if (res.ok) {
          alert('ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
          alert('ì´ˆê¸°í™” ì‹¤íŒ¨!');
        }
      }
    }

    async function loadTradeLogs() {
      const token = localStorage.getItem('token');
      console.log('call get logs API with token:', token);

      const res = await fetch('/trade-api/cashBalance', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      });

      const data = await res.json();

      const history = data.history || [];
      const list = document.getElementById('tradeArea');
      list.innerHTML = '';

      const totalItem = document.createElement('li');
      totalItem.textContent = `ì´ ê¸ˆì•¡: ${data.total}`;
      totalItem.style.fontWeight = 'bold';
      totalItem.style.marginBottom = '10px';
      list.appendChild(totalItem);
      
      history.sort((a, b) => new Date(a.time) - new Date(b.time));
      for (const item of history) {
        const li = document.createElement('li');
        li.textContent = `[${item.date}] ${item.type} ${item.price} X ${item.volume} ì´: ${item.price * item.volume}ì›`;
        list.appendChild(li);
      }
    }

    async function loadLogs() {
      const token = localStorage.getItem('token');
      console.log('call get logs API with token:', token);
      const res = await fetch('/trade-api/logs', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token }
      });

      const text = await res.text();
      console.log('load logs with text:', text);
      document.getElementById('logArea').textContent = text;
    }

    async function checkAuth() {
      console.log('âœ… auth-check start:'); 
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í¼ ë³´ì—¬ì£¼ê¸°'); 
        // í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í¼ ë³´ì—¬ì£¼ê¸°
        document.querySelector('#loginArea').style.display = 'block';
        return;
      }

      console.log('call auth-check API with token:', token);  // <-- 1. í† í° í™•ì¸
      const res = await fetch('/trade-api/auth-check', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      console.log('âœ… auth-check ì‘ë‹µ ìƒíƒœ:', res.status);  // <-- 2. ì‘ë‹µ ìƒíƒœ í™•ì¸
      if (res.ok) {
        showMain();
      } else {
        console.error('âŒ auth-check fetch ì‹¤íŒ¨:', err);
        showLogin();
      }
    }

    window.addEventListener('DOMContentLoaded', checkAuth);

    function showTab(tab) {
      const tradeBtn = document.getElementById('tabTrade');
      const logBtn = document.getElementById('tabLog');
      const tradeTab = document.getElementById('tradeTab');
      const logTab = document.getElementById('logTab');

      if (tab === 'trade') {
        tradeTab.style.display = 'block';
        logTab.style.display = 'none';
        tradeBtn.style.backgroundColor = '#4CAF50';
        tradeBtn.style.color = 'white';
        logBtn.style.backgroundColor = '#ddd';
        logBtn.style.color = 'black';
      } else {
        tradeTab.style.display = 'none';
        logTab.style.display = 'block';
        tradeBtn.style.backgroundColor = '#ddd';
        tradeBtn.style.color = 'black';
        logBtn.style.backgroundColor = '#4CAF50';
        logBtn.style.color = 'white';
      }
    }


function toggleInput(type) {
  /*
  if (type === 'volume') {
    document.getElementById('volume').disabled = false;
    document.getElementById('amount').disabled = true;
    document.getElementById('amountInput').style.display = 'block';
  } else {
    document.getElementById('volume').disabled = true;
    document.getElementById('amount').disabled = false;
    document.getElementById('amountInput').style.display = 'block';
  }
  */
}

</script>
</body>
</html>