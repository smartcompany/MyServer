<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>íŠ¸ë ˆì´ë”© ì„¤ì •</title>
</head>
<body>
  <h2>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
  <div id="loginArea">
    <form id="loginForm">
      <label>ID: <input id="id" type="text" placeholder="admin" autocomplete="username"/></label><br>
      <label>PW: <input id="pw" type="password" placeholder="password" autocomplete="current-password"/></label><br>
      <button type="submit">ë¡œê·¸ì¸</button>
    </form>
  </div>

  <div id="mainArea" style="display: none;">
    <h3>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ê¸°ì¤€ ì„¤ì •</h3>
    ë§¤ìˆ˜ ê¸°ì¤€: <input id="buy" type="number" step="0.01"><br>
    ë§¤ë„ ê¸°ì¤€: <input id="sell" type="number" step="0.01"><br>
    <button onclick="updateConfig()">ì„¤ì • ì ìš©</button>

    <h3>ìµœê·¼ ë¡œê·¸</h3>
    <pre id="logArea">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</pre>
  </div>

  <script>
    document.getElementById('loginForm').addEventListener('submit', function(event) {
      event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
      login();
    });

    let token = '';

    async function login() {
      const id = document.getElementById('id').value;
      const pw = document.getElementById('pw').value;

      const res = await fetch('/trade-api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password: pw })
      });

      if (res.ok) {
        const data = await res.json();
        token = data.token;
        console.log('ë¡œê·¸ì¸ ì„±ê³µ, í† í°: ì €ì¥ ', token);
        localStorage.setItem('token', token);

        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('mainArea').style.display = 'block';

        loadConfig();
        loadLogs();
        setInterval(loadLogs, 5000);
      } else {
        alert('ë¡œê·¸ì¸ ì‹¤íŒ¨!');
      }
    }

    async function loadConfig() {
      const res = await fetch('/trade-api/config', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      document.getElementById('buy').value = data.buyThreshold;
      document.getElementById('sell').value = data.sellThreshold;
    }

    async function updateConfig() {
      const buy = parseFloat(document.getElementById('buy').value);
      const sell = parseFloat(document.getElementById('sell').value);

      const res = await fetch('/trade-api/config', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
          updates: [
            { key: 'buyThreshold', value: buy },
            { key: 'sellThreshold', value: sell }
          ]
        })
      });

      if (res.ok) {
        alert('ì„¤ì •ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤');
      } else {
        alert('ì„¤ì • ì‹¤íŒ¨!');
      }
    }

    async function loadLogs() {
      const res = await fetch('/trade-api/logs', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const text = await res.text();
      document.getElementById('logArea').textContent = text;
    }

    async function checkAuth() {
      console.log('âœ… auth-check start:'); 
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í¼ ë³´ì—¬ì£¼ê¸°'); 
        // í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í¼ ë³´ì—¬ì£¼ê¸°
        document.querySelector('#loginArea').style.display = 'block';
        return;
      }

      console.log('call auth-check API with token:', token);  // <-- 1. í† í° í™•ì¸
      const res = await fetch('/trade-api/auth-check', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      console.log('âœ… auth-check ì‘ë‹µ ìƒíƒœ:', res.status);  // <-- 2. ì‘ë‹µ ìƒíƒœ í™•ì¸
      if (res.ok) {
        document.querySelector('#mainArea').style.display = 'block';
        document.querySelector('#loginArea').style.display = 'none';
      } else {
        console.error('âŒ auth-check fetch ì‹¤íŒ¨:', err);
        localStorage.removeItem('token');
        document.querySelector('#loginArea').style.display = 'block';
      }
    }

    window.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>