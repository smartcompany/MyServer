#!/bin/bash

# Git pull í›„ ìë™ìœ¼ë¡œ ë¹Œë“œ ë° ì¬ì‹œì‘í•˜ëŠ” hook

echo "ğŸ”„ Git pull ì™„ë£Œ, ìë™ ì¬ì‹œì‘ ì‹œì‘... "

# í•­ìƒ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
ROOT_DIR="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -n "$ROOT_DIR" ]; then
  cd "$ROOT_DIR" || exit 1
fi


# PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
if ! command -v pm2 &> /dev/null; then
    echo "âš ï¸  PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤."
    exit 0
fi

# ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ(ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ) ëª©ë¡
# ì—¬ê¸°ì—ëŠ” "ê²½ë¡œ"ë§Œ ë„£ìœ¼ë©´ ë¨. PM2 ì•±ëª…ì€ íŒŒì¼ëª…(í™•ì¥ì ì œì™¸)ë¡œ ìë™ ìƒì„±ë¨.
# ì˜ˆ: my-bot.js -> pm2 app name: my-bot
MONITOR_FILES=(
  "my-bot.js"
  "coin-portal-bot/coin-portal-bot.js"
  "coin-portal-bot/ping.js"
  "ping.js"
)

NEED_PM2_SAVE=0

# ë³€ê²½ëœ íŒŒì¼ í™•ì¸
CHANGED_FILES=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD 2>/dev/null || echo "")

changed() {
  local pattern="$1"
  echo "$CHANGED_FILES" | grep -qE "$pattern"
}

# ë³€ê²½ëœ íŒŒì¼(ê²½ë¡œ)ì„ ì •í™•íˆ ë§¤ì¹­ (ì •ê·œì‹ ì´ìŠ¤ì¼€ì´í”„ í•„ìš” ì—†ìŒ)
changed_file() {
  local file_path="$1"
  echo "$CHANGED_FILES" | grep -qxF "$file_path"
}

# pm2 ì•±ì„ "delete -> start"ë¡œ ì¬ìƒì„± (í”„ë¡œì„¸ìŠ¤ê°€ ì—†ì–´ë„ deleteëŠ” ë¬´ì‹œ)
# - app_name: pm2 í”„ë¡œì„¸ìŠ¤ëª… (--name)
# - start_cmd: pm2 startì— ë„˜ê¸¸ ì»¤ë§¨ë“œ (ì˜ˆ: "npm -- start")
pm2_recreate() {
  local app_name="$1"
  local start_cmd="$2"
  echo "ğŸ—‘ï¸  ê¸°ì¡´ ${app_name} í”„ë¡œì„¸ìŠ¤ ì‚­ì œ ì¤‘..."
  pm2 delete "$app_name" 2>/dev/null || true

  echo "ğŸš€ ${app_name} ì‹œì‘ ì¤‘..."
  if [ -z "$start_cmd" ]; then
    echo "âŒ start_cmdê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤: $app_name"
    return 1
  fi

  # start_cmdëŠ” ì—¬ëŸ¬ í† í°ì¼ ìˆ˜ ìˆì–´ evalë¡œ ì‹¤í–‰ (MONITOR_RULESì—ì„œë§Œ ì…ë ¥)
  eval "pm2 start $start_cmd --name \"$app_name\""
}

# íŒŒì¼ ê²½ë¡œë§Œ ì£¼ë©´ pm2 ì•±ëª…ì„ íŒŒì¼ëª…ìœ¼ë¡œ ìë™ ìƒì„±í•´ì„œ ì¬ì‹œì‘
# ì˜ˆ: "my-bot.js" -> app "my-bot"
pm2_recreate_by_file() {
  local file_path="$1"
  local base
  local app_name

  base="$(basename "$file_path")"
  app_name="${base%.*}"

  if [ -z "$app_name" ]; then
    echo "âŒ ì•± ì´ë¦„ ì¶”ì¶œ ì‹¤íŒ¨: $file_path"
    return 1
  fi

  echo "ğŸ—‘ï¸  ê¸°ì¡´ ${app_name} í”„ë¡œì„¸ìŠ¤ ì‚­ì œ ì¤‘..."
  pm2 delete "$app_name" 2>/dev/null || true

  echo "ğŸš€ ${app_name} ì‹œì‘ ì¤‘... (file=${file_path})"
  # ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ìƒëŒ€ ê²½ë¡œ íŒŒì¼ë“¤ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ í•¨
  pm2 start "$file_path" --name "$app_name" --cwd "$ROOT_DIR"
}
# package.jsonì´ë‚˜ package-lock.jsonì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
if echo "$CHANGED_FILES" | grep -qE "(package\.json|package-lock\.json)"; then
    echo "ğŸ“¦ ì˜ì¡´ì„± íŒŒì¼ ë³€ê²½ë¨, ì„¤ì¹˜ ì¤‘..."
    npm install
else
    echo "â„¹ï¸  ì˜ì¡´ì„± íŒŒì¼ ë³€ê²½ ì—†ìŒ, ì„¤ì¹˜ ìŠ¤í‚µ"
fi

# node_modulesê°€ ì—†ê±°ë‚˜ nextê°€ ì—†ìœ¼ë©´ ì„¤ì¹˜ (ì•ˆì „ì¥ì¹˜)
# nextëŠ” dependenciesì— ìˆìœ¼ë¯€ë¡œ --productionìœ¼ë¡œë„ ì„¤ì¹˜ë˜ì–´ì•¼ í•˜ì§€ë§Œ,
# í˜¹ì‹œ ëª¨ë¥¼ ìƒí™©ì„ ëŒ€ë¹„í•œ ì²´í¬
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/next" ]; then
    echo "âš ï¸  node_modulesê°€ ì—†ê±°ë‚˜ nextê°€ ì—†ìŒ, ì„¤ì¹˜ ì¤‘..."
    npm install
fi

# ë¹Œë“œê°€ í•„ìš”í•œ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
# app/, trade-server/ ë””ë ‰í† ë¦¬, next.config.js, instrumentation.js, package.json ë³€ê²½ ì‹œì—ë§Œ ë¹Œë“œ í•„ìš”
# ì •ì  íŒŒì¼ì€ ë¹Œë“œ ë¶ˆí•„ìš”
if changed "(^app/|^trade-server/|^next\.config\.js$|^instrumentation\.js$|^package\.json$)"; then
    echo "ğŸ”¨ ë¹Œë“œ í•„ìš”í•œ íŒŒì¼ ë³€ê²½ë¨, ë¹Œë“œ ì¤‘..."
    npm run build
else
    echo "â„¹ï¸  ë¹Œë“œ í•„ìš”í•œ íŒŒì¼ ë³€ê²½ ì—†ìŒ, ë¹Œë“œ ìŠ¤í‚µ (ì •ì  íŒŒì¼ë§Œ ë³€ê²½ëœ ê²½ìš° ì¬ì‹œì‘ë§Œ)"
fi

# Next.js ì„œë²„ëŠ” í•­ìƒ ì¬ì‹œì‘ (git pull ì´í›„ ì½”ë“œ ë°˜ì˜ ëª©ì )
# ì£¼ì˜: pm2ì˜ --name ì˜µì…˜ì€ "--" êµ¬ë¶„ìë³´ë‹¤ ì•ì— ì™€ì•¼ í•¨ (npm startì˜ "--" ë•Œë¬¸ì— ìˆœì„œ ì¤‘ìš”)
echo "ğŸ”„ Next.js ì„œë²„ ì‹œì‘ ì¤‘..."
pm2 delete nextjs-server 2>/dev/null || true

# ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ next ëª…ë ¹ì–´ë¥¼ ì°¾ì„ ìˆ˜ ìˆë„ë¡ í•¨
cd "$ROOT_DIR" || exit 1
pm2 start npm --name nextjs-server --cwd "$ROOT_DIR" -- start
NEED_PM2_SAVE=1

# ë‚˜ë¨¸ì§€ ë´‡ë“¤ì€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì¬ì‹œì‘
for file_path in "${MONITOR_FILES[@]}"; do
  if changed_file "$file_path"; then
    echo "ğŸ” ë³€ê²½ ê°ì§€: ${file_path}"
    pm2_recreate_by_file "$file_path" && NEED_PM2_SAVE=1
  else
    echo "â„¹ï¸  ë³€ê²½ ì—†ìŒ: ${file_path}"
  fi
done

if [ "$NEED_PM2_SAVE" -eq 1 ]; then
  pm2 save
fi

echo "âœ… ìë™ ì¬ì‹œì‘ ì™„ë£Œ!"

